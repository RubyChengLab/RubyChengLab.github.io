---
layout: default
title: Falling Comet Lab
---
<style>
    body {
      background: url('/images/20efc85c275d9dcb694f84c6dd2d5378_t.jpeg') no-repeat center center fixed;
      background-size: cover;
    }
    main {
      max-width: 960px;
      margin: 100px auto;
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
  </style>

<section>
<h2>📌 最新文章</h2>
<ul>
{% for post in site.posts limit:5 %}
<li><a href="{{ post.url }}">{{ post.title }}</a> ({{ post.date | date: "%Y-%m-%d" }})</li>
{% endfor %}
</ul>
</section>

<section>
<h2>🔥 熱門文章</h2>
<ul id="popular-posts"><li>載入中...</li></ul>
</section>

<section>
<h2>🏷️ 標籤雲</h2>
{% for tag in site.tags %}
<a href="/tags/{{ tag[0] }}" style="font-size: {{ tag[1].size | times: 8 | plus: 80 }}%;">{{ tag[0] }}</a>
{% endfor %}
</section>

<div id="view-counter" style="margin-top:24px;"></div>

<script>
const posts = [
{% for post in site.posts %}
{ title: "{{ post.title | escape }}", url: "{{ post.url }}" },
{% endfor %}
];
document.getElementById("search-input").addEventListener("input", function () {
  const q = this.value.toLowerCase();
  const results = posts.filter(p => p.title.toLowerCase().includes(q));
  const container = document.getElementById("search-results");
  container.innerHTML = q.length < 2 ? '' : results.map(p => `<li><a href="${p.url}">${p.title}</a></li>`).join('') || '<li>找不到文章</li>';
});
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, limit, getDocs, doc, updateDoc, increment, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "...",
  authDomain: "...",
  projectId: "...",
});
const db = getFirestore(app);

async function loadPopular() {
  const q = query(collection(db, "posts"), orderBy("views", "desc"), limit(5));
  const querySnapshot = await getDocs(q);
  const container = document.getElementById("popular-posts");
  container.innerHTML = "";
  querySnapshot.forEach(docSnap => {
    const data = docSnap.data();
    const link = docSnap.id.replace(/_/g, "/");
    container.innerHTML += `<li><a href="${link}">${data.title || link} (${data.views}次瀏覽)</a></li>`;
  });
}

async function countView() {
  const id = location.pathname.replace(/\//g, "_") || "index";
  const ref = doc(db, "posts", id);
  try { await updateDoc(ref, { views: increment(1) }); } catch { await setDoc(ref, { views: 1 }); }
  const snap = await getDoc(ref);
  if (snap.exists()) document.getElementById("view-counter").innerText = `👁️ 本頁瀏覽次數：${snap.data().views}`;
}

loadPopular();
countView();
</script>
