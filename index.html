<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Falling Comet Lab</title>
  <link rel="stylesheet" href="/assets/css/main.css">
  <style>
    body {
      background-image: url('https://rubychenglab.github.io/images/20efc85c275d9dcb694f84c6dd2d5378_t.jpeg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #2a2a2a;
    }
    .content-container {
      background-color: rgba(255, 255, 255, 0.85);
      border-radius: 12px;
      padding: 40px;
      margin: 120px auto 60px auto;
      max-width: 960px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 24px;
      border-bottom: 1px solid #ddd;
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #fff;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
      z-index: 100;
    }
  </style>
</head>
<body>

<header>
  <h1>ğŸŒ  Falling Comet Lab</h1>
  <div style="width: 100%; max-width: 960px; display: flex; justify-content: space-between; align-items: flex-start;">
    <div style="flex: 1; margin-right: 20px;">
      <h2 style="font-size: 1rem; margin-bottom: 6px;">ğŸ” æœå°‹æ–‡ç« </h2>
      <input type="text" id="search-input" placeholder="è¼¸å…¥é—œéµå­—æœå°‹æ–‡ç« " style="width: 100%; padding: 0.5em; font-size: 1rem; border-radius: 6px; border: 1.5px solid #ccc;">
      <ul id="search-results" style="margin-top: 10px; max-height: 180px; overflow-y: auto; background: #fefefe; border: 1px solid #ddd; border-radius: 6px; padding-left: 1em; font-size: 0.9rem;"></ul>
    </div>
    <nav>
      <ul style="list-style: none; display: flex; gap: 1em; margin: 0; padding: 0;">
        <li><a href="/categories/Arduino/">Arduino</a></li>
        <li><a href="/categories/Math/">Math</a></li>
        <li><a href="/categories/Electronics/">Electronics</a></li>
        <li><a href="/about/">é—œæ–¼æˆ‘</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="content-container">

  <h2>ğŸ”§ æœ€æ–°æ–‡ç« </h2>
  <ul>
    {% for post in site.posts limit:5 %}
      <li>
        <a href="{{ post.url }}" style="color: #4a90e2; font-weight: 600;">{{ post.title }}</a>
        <small style="color: #666;">({{ post.date | date: "%Y-%m-%d" }})</small>
        {% if post.categories.size > 0 %}
          <em style="color: #999;">â€” åˆ†é¡: {{ post.categories | join: ', ' }}</em>
        {% endif %}
      </li>
    {% endfor %}
  </ul>

  <h2>ğŸ”¥ ç†±é–€æ–‡ç« æ’è¡Œ</h2>
<ul>
  {% assign sorted_posts = site.posts | sort: 'views' | reverse %}
  {% for post in sorted_posts limit:5 %}
    <li>
      <a href="{{ post.url }}" style="color: #4a90e2; font-weight: 600;">{{ post.title }}</a>
      <small style="color: #666;">ï¼ˆç€è¦½æ¬¡æ•¸ï¼š{{ post.views }}ï¼‰</small>
    </li>
  {% endfor %}
</ul>

  <div id="tag-cloud" style="margin-top: 40px;">
    <h2>ğŸ“Œ æ¨™ç±¤é›²</h2>
    {% assign max_size = 0 %}
    {% for tag in site.tags %}
      {% if tag[1].size > max_size %}
        {% assign max_size = tag[1].size %}
      {% endif %}
    {% endfor %}
    {% for tag in site.tags %}
      {% assign size = tag[1].size | times: 1.0 %}
      {% assign font_size = size | divided_by: max_size | times: 120 | plus: 80 %}
      <a href="/tags/{{ tag[0] }}" style="font-size: {{ font_size | round }}%; margin-right: 0.7rem; text-decoration: none; color: #4a90e2;">{{ tag[0] }}</a>
    {% endfor %}
  </div>

  <div id="view-counter" style="margin-top: 40px; font-size: 1rem; color: #444;"></div>

</div>

{% include footer.html %}

<script>
const posts = [
  {% for post in site.posts %}
  {
    title: "{{ post.title | escape }}",
    url: "{{ post.url }}",
    content: "{{ post.content | strip_html | strip_newlines | escape }}"
  },
  {% endfor %}
];

const searchInput = document.getElementById("search-input");
const searchResults = document.getElementById("search-results");

searchInput.addEventListener("input", () => {
  const q = searchInput.value.toLowerCase();
  searchResults.innerHTML = "";
  if (q.length < 2) return;

  const filtered = posts.filter(p => p.title.toLowerCase().includes(q) || p.content.toLowerCase().includes(q));
  if (filtered.length === 0) {
    searchResults.innerHTML = "<li>æ‰¾ä¸åˆ°ç¬¦åˆçš„æ–‡ç« </li>";
    return;
  }

  filtered.forEach(p => {
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.href = p.url;
    a.textContent = p.title;
    a.style.color = "#2a2a2a";
    a.style.textDecoration = "none";
    a.onmouseover = () => a.style.textDecoration = "underline";
    a.onmouseout = () => a.style.textDecoration = "none";
    li.appendChild(a);
    searchResults.appendChild(li);
  });
});
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, limit, getDocs, doc, updateDoc, increment, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBmR7K4ECZA0Vv0PlHn6dMxg5P06UsBnq0",
  authDomain: "falling-comet-lab-blog.firebaseapp.com",
  projectId: "falling-comet-lab-blog",
  storageBucket: "falling-comet-lab-blog.appspot.com",
  messagingSenderId: "275403715950",
  appId: "1:275403715950:web:25383ec082d6ff3338bd7f",
  measurementId: "G-TRDSPMNYQK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function loadPopularPosts() {
  const popularPostsEl = document.getElementById("popular-posts");
  const q = query(collection(db, "posts"), orderBy("views", "desc"), limit(5));
  const querySnapshot = await getDocs(q);

  popularPostsEl.innerHTML = "";

  querySnapshot.forEach(docSnap => {
    const data = docSnap.data();
    const id = docSnap.id.replace(/_/g, "/");
    const title = data.title || id;
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.href = id === "index" ? "/" : id;
    a.textContent = `${title}ï¼ˆç€è¦½: ${data.views || 0}ï¼‰`;
    a.style.color = "#4a90e2";
    a.style.textDecoration = "none";
    a.onmouseover = () => a.style.textDecoration = "underline";
    a.onmouseout = () => a.style.textDecoration = "none";
    li.appendChild(a);
    popularPostsEl.appendChild(li);
  });

  if (querySnapshot.empty) {
    popularPostsEl.innerHTML = "<li>é‚„æ²’æœ‰ç†±é–€æ–‡ç« å–”ï¼</li>";
  }
}

async function countView() {
  const pagePath = location.pathname.replace(/\//g, "_") || "index";
  const postRef = doc(db, "posts", pagePath);

  try {
    await updateDoc(postRef, { views: increment(1) });
  } catch {
    await setDoc(postRef, { views: 1 });
  }

  const postSnap = await getDoc(postRef);
  if (postSnap.exists()) {
    document.getElementById("view-counter").innerHTML = `ğŸ‘ï¸ æœ¬é ç€è¦½æ¬¡æ•¸ï¼š${postSnap.data().views}`;
  }
}

loadPopularPosts();
countView();
</script>

</body>
</html>
