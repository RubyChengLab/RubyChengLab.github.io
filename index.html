<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ğŸŒ  Falling Comet Lab</title>
  <link rel="stylesheet" href="/assets/css/main.css">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #fafafa;
      color: #333;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 16px 24px;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header .title {
      font-size: 1.8rem;
      font-weight: bold;
      white-space: nowrap;
    }
    nav a {
      margin-left: 16px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
    }
    nav a:hover {
      color: #0077ff;
    }
    main {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 24px;
    }
    #search-input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 24px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    section h2 {
      font-size: 1.4rem;
      margin-bottom: 12px;
      margin-top: 32px;
    }
    ul {
      padding-left: 20px;
    }
    a {
      color: #0077ff;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<header>
  <div class="title">ğŸŒ  Falling Comet Lab</div>
  <nav>
    <a href="/arduino/">Arduino</a>
    <a href="/math/">Math</a>
    <a href="/electronics/">Electronics</a>
    <a href="/about/">é—œæ–¼æˆ‘</a>
  </nav>
</header>

<main>
  <input id="search-input" type="text" placeholder="ğŸ” æœå°‹æ–‡ç« ">

  <ul id="search-results" style="list-style: none; padding-left: 0;"></ul>

  <section>
    <h2>ğŸ“Œ æœ€æ–°æ–‡ç« </h2>
    <ul>
      {% for post in site.posts limit:5 %}
      <li><a href="{{ post.url }}">{{ post.title }}</a> ({{ post.date | date: "%Y-%m-%d" }})</li>
      {% endfor %}
    </ul>
  </section>

  <section>
    <h2>ğŸ”¥ ç†±é–€æ–‡ç« </h2>
    <ul id="popular-posts"><li>è¼‰å…¥ä¸­...</li></ul>
  </section>

  <section>
    <h2>ğŸ·ï¸ æ¨™ç±¤é›²</h2>
    {% for tag in site.tags %}
    <a href="/tags/{{ tag[0] }}" style="font-size: {{ tag[1].size | times: 8 | plus: 80 }}%;">{{ tag[0] }}</a>
    {% endfor %}
  </section>

  <div id="view-counter" style="margin-top: 24px;"></div>
</main>

<script>
// ç°¡å–®æœå°‹åŠŸèƒ½
const posts = [
  {% for post in site.posts %}
  { title: "{{ post.title | escape }}", url: "{{ post.url }}" },
  {% endfor %}
];
document.getElementById("search-input").addEventListener("input", function () {
  const q = this.value.toLowerCase();
  const results = posts.filter(p => p.title.toLowerCase().includes(q));
  const container = document.getElementById("search-results");
  container.innerHTML = q.length < 2 ? '' : results.map(p => `<li><a href="${p.url}">${p.title}</a></li>`).join('') || '<li>æ‰¾ä¸åˆ°æ–‡ç« </li>';
});
</script>

<script type="module">
// Firebase ç†±é–€æ–‡ç« ã€ç€è¦½æ¬¡æ•¸
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, limit, getDocs, doc, updateDoc, increment, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "...",
  authDomain: "...",
  projectId: "...",
});
const db = getFirestore(app);

async function loadPopular() {
  const q = query(collection(db, "posts"), orderBy("views", "desc"), limit(5));
  const querySnapshot = await getDocs(q);
  const container = document.getElementById("popular-posts");
  container.innerHTML = "";
  querySnapshot.forEach(docSnap => {
    const data = docSnap.data();
    const link = docSnap.id.replace(/_/g, "/");
    container.innerHTML += `<li><a href="${link}">${data.title || link} (${data.views}æ¬¡ç€è¦½)</a></li>`;
  });
}

async function countView() {
  const id = location.pathname.replace(/\//g, "_") || "index";
  const ref = doc(db, "posts", id);
  try { await updateDoc(ref, { views: increment(1) }); } catch { await setDoc(ref, { views: 1 }); }
  const snap = await getDoc(ref);
  if (snap.exists()) document.getElementById("view-counter").innerText = `ğŸ‘ï¸ æœ¬é ç€è¦½æ¬¡æ•¸ï¼š${snap.data().views}`;
}

loadPopular();
countView();
</script>

</body>
</html>
